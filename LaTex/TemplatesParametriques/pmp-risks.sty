% Package Dollarama PMP Risk Management
% Système d'analyse de risques conforme aux standards PMP
% Matrice Impact × Probabilité selon PMI Guidelines
% Version: 1.0

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{dollarama-pmp-risks}[2025/01/09 v1.0 Dollarama PMP Risk Analysis]

% Packages requis
\RequirePackage{dollarama-business}  % For table headers and currency commands
\RequirePackage{tcolorbox}
\RequirePackage{array}
\RequirePackage{colortbl}
\RequirePackage{longtable}
\RequirePackage{tikz}
\RequirePackage{pgfplots}
\RequirePackage{environ}

% Chargement des bibliothèques TikZ
\usetikzlibrary{positioning,shapes,arrows,matrix}

% ===============================================
% STYLES DE TABLEAUX STANDARDISÉS PMP
% ===============================================

% Table header commands are defined in dollarama-business.sty

% ===============================================
% TABLE DE RISQUES
% ===============================================

% Table de risques avec scores PMBoK et légende intégrée
\newenvironment{dollaramarisktable}[2]{
    \begin{table}[H]
    \centering
    \caption{#1}
    \label{#2}
    \begin{tabular}{|p{0.25\textwidth}|c|c|c|c|c|p{0.3\textwidth}|}
    \hline
    \dollaramatabheader
    \dollaramatabheadertext{Risque} & 
    \dollaramatabheadertext{Probabilité} & 
    \dollaramatabheadertext{Impact} & 
    \dollaramatabheadertext{Score} & 
    \dollaramatabheadertext{Mitigation} \\
    \hline
}
{
    \hline
    \multicolumn{3}{|c|}{\cellcolor{DollaramaYellow}\small\textbf{Échelle des Risques PMBoK}} & 
    \multicolumn{2}{c|}{\cellcolor{DollaramaYellow}\small\textbf{Score de Risque :}}\\
    \hline
    \multicolumn{1}{|c|}{\cellcolor{DollaramaGreen!5}\footnotesize\risklow} & 
    \multicolumn{1}{c|}{\cellcolor{DollaramaGreen!5}\footnotesize\riskmedium} & 
    \multicolumn{1}{c|}{\cellcolor{DollaramaGreen!5}\footnotesize\riskhigh} & 
    \multicolumn{2}{c|}{\cellcolor{DollaramaGreen!10}\small{Probabilité × Impact}}\\
    \hline
    \end{tabular}
    \end{table}
}

% ===============================================
% INDICATEURS DE RISQUE AVEC SCORES
% ===============================================

% Indicateurs de risque avec scores PMBoK
\newcommand{\risklow}{\cellcolor{green!30}\textbf{Faible 0.1}}
\newcommand{\riskmedium}{\cellcolor{yellow!50}\textbf{Moyen 0.3}}
\newcommand{\riskhigh}{\cellcolor{red!30}\textbf{Élevé 0.5}}

% Légende des scores de risque - Version attachée à la table
\newcommand{\risklegend}{
    \begin{center}
    \begin{tcolorbox}[
        colback=DollaramaGreen!10,
        colframe=DollaramaGreen,
        boxrule=1pt,
        arc=3pt,
        width=0.85\textwidth,
        left=8pt,
        right=8pt,
        top=8pt,
        bottom=8pt
    ]
    \begin{center}
    \textbf{Échelle des Risques PMBoK}
    \end{center}
    \vspace{0.3em}
    
    \begin{tabular}{ccc}
    \risklow & \riskmedium & \riskhigh \\
    Faible (0.1) & Moyen (0.3) & Élevé (0.5) \\
    \end{tabular}
    
    \vspace{0.3em}
    \textbf{Score de Risque :} Probabilité × Impact
    \end{tcolorbox}
    \end{center}
}

% ===============================================
% DÉFINITIONS DES NIVEAUX DE RISQUE PMP
% ===============================================

% Probabilité (selon PMP standards)
\newcommand{\probveryhigh}{\cellcolor{red!70}\textbf{0.9}}      % 90%
\newcommand{\probhigh}{\cellcolor{red!50}\textbf{0.7}}          % 70%
\newcommand{\probmedium}{\cellcolor{yellow!60}\textbf{0.5}}     % 50%
\newcommand{\problow}{\cellcolor{yellow!30}\textbf{0.3}}        % 30%
\newcommand{\probverylow}{\cellcolor{green!30}\textbf{0.1}}     % 10%

% Impact (selon PMP standards)
\newcommand{\impactveryhigh}{\cellcolor{red!70}\textbf{0.8}}    % Très élevé
\newcommand{\impacthigh}{\cellcolor{red!50}\textbf{0.4}}        % Élevé
\newcommand{\impactmedium}{\cellcolor{yellow!60}\textbf{0.2}}   % Moyen
\newcommand{\impactlow}{\cellcolor{yellow!30}\textbf{0.1}}      % Faible
\newcommand{\impactverylow}{\cellcolor{green!30}\textbf{0.05}}  % Très faible

% Scores de risque calculés (Impact × Probabilité)
\newcommand{\riskcritical}[1]{\cellcolor{red!80}\textbf{\color{white}#1}}      % > 0.5
\newcommand{\pmpriskhigh}[1]{\cellcolor{red!60}\textbf{\color{white}#1}}          % 0.3-0.5
\newcommand{\pmpriskmedium}[1]{\cellcolor{yellow!70}\textbf{#1}}                  % 0.1-0.3
\newcommand{\pmprisklow}[1]{\cellcolor{yellow!40}\textbf{#1}}                     % 0.05-0.1
\newcommand{\pmpriskverylow}[1]{\cellcolor{green!40}\textbf{#1}}                  % < 0.05

% ===============================================
% MATRICE DE RISQUE PMP STANDARD
% ===============================================

\newcommand{\pmpriskmatrix}{
    \begin{table}[H]
    \centering
    \caption{Matrice de Risque PMP - Impact × Probabilité}
    \label{tab:pmp-risk-matrix}
    \begin{tabular}{|l|c|c|c|c|c|}
    \hline
    \dollaramatabheader
    \dollaramatabheadertext{Impact/Probabilité} & 
    \dollaramatabheadertext{Très Faible} & 
    \dollaramatabheadertext{Faible} & 
    \dollaramatabheadertext{Moyen} & 
    \dollaramatabheadertext{Élevé} & 
    \dollaramatabheadertext{Très Élevé} \\
    \hline
    \textbf{Très Élevé (0.8)} & \pmpriskmedium{0.08} & \pmpriskmedium{0.24} & \pmpriskhigh{0.40} & \riskcritical{0.56} & \riskcritical{0.72} \\
    \hline
    \textbf{Élevé (0.4)} & \pmprisklow{0.04} & \pmpriskmedium{0.12} & \pmpriskmedium{0.20} & \pmpriskmedium{0.28} & \pmpriskhigh{0.36} \\
    \hline
    \textbf{Moyen (0.2)} & \pmprisklow{0.02} & \pmprisklow{0.06} & \pmpriskmedium{0.10} & \pmpriskmedium{0.14} & \pmpriskmedium{0.18} \\
    \hline
    \textbf{Faible (0.1)} & \pmpriskverylow{0.01} & \pmprisklow{0.03} & \pmprisklow{0.05} & \pmprisklow{0.07} & \pmprisklow{0.09} \\
    \hline
    \textbf{Très Faible (0.05)} & \pmpriskverylow{0.005} & \pmpriskverylow{0.015} & \pmprisklow{0.025} & \pmprisklow{0.035} & \pmprisklow{0.045} \\
    \hline
    \end{tabular}
    \end{table}
    
    \vspace{0.5em}
    \begin{tcolorbox}[
        colback=DollaramaGreen!10,
        colframe=DollaramaGreen,
        boxrule=1pt,
        arc=2pt,
        title={\textbf{Légende PMP Risk Scoring}}
    ]
    \begin{tabular}{ll}
    \riskcritical{0.5+} & \textbf{Critique:} Action immédiate requise \\
    \pmpriskhigh{0.3-0.5} & \textbf{Élevé:} Surveillance active et plans de mitigation \\
    \pmpriskmedium{0.1-0.3} & \textbf{Moyen:} Surveillance régulière \\
    \pmprisklow{0.05-0.1} & \textbf{Faible:} Surveillance périodique \\
    \pmpriskverylow{<0.05} & \textbf{Très Faible:} Surveillance minimale
    \end{tabular}
    \end{tcolorbox}
}

% ===============================================
% REGISTRE DES RISQUES PMP
% ===============================================

% Table de registre des risques PMP sans sections codées
% Usage: \begin{pmpriskreregister}{titre}{label}
\newenvironment{pmpriskreregister}[2]{
    \begin{longtable}{|p{0.15\textwidth}|p{0.25\textwidth}|c|c|c|p{0.3\textwidth}|}
    \caption{#1} \label{#2} \\
    \hline
    \dollaramatabheader
    \dollaramatabheadertext{ID} & 
    \dollaramatabheadertext{Description du Risque} & 
    \dollaramatabheadertext{Prob.} & 
    \dollaramatabheadertext{Impact} & 
    \dollaramatabheadertext{Score} & 
    \dollaramatabheadertext{Stratégie de Réponse} \\
    \hline
    \endfirsthead
    
    \multicolumn{6}{c}%
    {{\tablename\ \thetable{} -- Suite de la page précédente}} \\
    \hline
    \dollaramatabheader
    \dollaramatabheadertext{ID} & 
    \dollaramatabheadertext{Description du Risque} & 
    \dollaramatabheadertext{Prob.} & 
    \dollaramatabheadertext{Impact} & 
    \dollaramatabheadertext{Score} & 
    \dollaramatabheadertext{Stratégie de Réponse} \\
    \hline
    \endhead
    
    \hline \multicolumn{6}{|r|}{{Suite sur la page suivante}} \\ \hline
    \endfoot
    
    \hline
    \endlastfoot
}{
    \end{longtable}
}

% Ligne de risque pour le registre
\newcommand{\riskentry}[6]{
    #1 & #2 & #3 & #4 & #5 & #6 \\
    \hline
}

% ===============================================
% STRATÉGIES DE RÉPONSE AUX RISQUES PMP
% ===============================================

% Stratégies pour risques négatifs (menaces)
\newcommand{\mitigate}[1]{\textcolor{blue}{\textbf{ATTÉNUER:}} #1}
\newcommand{\avoid}[1]{\textcolor{red}{\textbf{ÉVITER:}} #1}
\newcommand{\transfer}[1]{\textcolor{orange}{\textbf{TRANSFÉRER:}} #1}
\newcommand{\accept}[1]{\textcolor{green}{\textbf{ACCEPTER:}} #1}

% Stratégies pour risques positifs (opportunités)
\newcommand{\exploit}[1]{\textcolor{DollaramaGreen}{\textbf{EXPLOITER:}} #1}
\newcommand{\enhance}[1]{\textcolor{blue}{\textbf{AMÉLIORER:}} #1}
\newcommand{\share}[1]{\textcolor{purple}{\textbf{PARTAGER:}} #1}

% ===============================================
% ANALYSE QUANTITATIVE DES RISQUES
% ===============================================

\newcommand{\quantitativeriskanalysis}[4]{
    \begin{table}[H]
    \centering
    \caption{Analyse Quantitative des Risques - Métriques PMP}
    \label{tab:quantitative-risk}
    \begin{tabular}{|p{0.3\textwidth}|r|r|r|}
    \hline
    \dollaramatabheader
    \dollaramatabheadertext{Métrique} & 
    \dollaramatabheadertext{Valeur} & 
    \dollaramatabheadertext{Seuil} & 
    \dollaramatabheadertext{Status} \\
    \hline
    Exposition totale au risque & \currency{#1} & \currency{#2} & #3 \\
    \hline
    \rowcolor{gray!10}
    Réserve de contingence requise & \currency{#4} & \currency{#2} & #3 \\
    \hline
    Probabilité de succès du projet & \percentage{#1} & \percentage{80} & #3 \\
    \hline
    \rowcolor{gray!10}
    Délai probable (P80) & #1 mois & #2 mois & #3 \\
    \hline
    \end{tabular}
    \end{table}
}

% ===============================================
% PLAN DE GESTION DES RISQUES
% ===============================================

% Boîte pour plan de gestion des risques avec formatage
% Usage: \begin{pmpriskmanagementplan}{titre optionnel}
\NewEnviron{pmpriskmanagementplan}[1]{
    \begin{tcolorbox}[
        colback=DollaramaGreen!5,
        colframe=DollaramaGreen,
        boxrule=2pt,
        arc=3pt,
        title={\color{DollaramaGreen}\textbf{#1}}
    ]
    \BODY
    \end{tcolorbox}
}

% ===============================================
% PROCESSUS PMP DE GESTION DES RISQUES
% ===============================================

\newcommand{\pmpriskprocess}{
    \begin{tikzpicture}[
        node distance=2cm,
        process/.style={rectangle, rounded corners, minimum width=3cm, minimum height=1cm, text centered, draw=DollaramaGreen, fill=DollaramaGreen!20, font=\small},
        arrow/.style={thick,->,>=stealth,color=DollaramaGreen}
    ]
    
    \node (plan) [process] {1. Planifier la Gestion des Risques};
    \node (identify) [process, below of=plan] {2. Identifier les Risques};
    \node (qualitative) [process, below of=identify] {3. Analyse Qualitative};
    \node (quantitative) [process, below of=qualitative] {4. Analyse Quantitative};
    \node (response) [process, below of=quantitative] {5. Planifier les Réponses};
    \node (monitor) [process, below of=response] {6. Surveiller les Risques};
    
    \draw [arrow] (plan) -- (identify);
    \draw [arrow] (identify) -- (qualitative);
    \draw [arrow] (qualitative) -- (quantitative);
    \draw [arrow] (quantitative) -- (response);
    \draw [arrow] (response) -- (monitor);
    \draw [arrow] (monitor.east) -- ++(2,0) |- (identify.east);
    
    \end{tikzpicture}
}

% ===============================================
% TABLEAUX DE BORD RISQUES PMP
% ===============================================

\newcommand{\riskdashboardpmp}[5]{
    \vspace{1em}
    \begin{center}
    \fcolorbox{DollaramaGreen}{DollaramaGreen!5}{%
    \begin{minipage}{0.9\textwidth}
    \vspace{0.5em}
    \begin{center}
    {\Large\bfseries\color{DollaramaGreen} TABLEAU DE BORD RISQUES PMP}
    \end{center}
    \vspace{0.5em}
    
    \begin{tabular}{p{0.18\textwidth}p{0.18\textwidth}p{0.18\textwidth}p{0.18\textwidth}p{0.18\textwidth}}
    \centering
    \fcolorbox{red}{white}{%
    \begin{minipage}{0.16\textwidth}
    \centering
    \textbf{Critiques}\\
    \vspace{0.2em}
    {\Large\color{red}#1}
    \end{minipage}
    } & 
    \centering
    \fcolorbox{orange}{white}{%
    \begin{minipage}{0.16\textwidth}
    \centering
    \textbf{Élevés}\\
    \vspace{0.2em}
    {\Large\color{orange}#2}
    \end{minipage}
    } &
    \centering
    \fcolorbox{yellow}{white}{%
    \begin{minipage}{0.16\textwidth}
    \centering
    \textbf{Moyens}\\
    \vspace{0.2em}
    {\Large\color{orange}#3}
    \end{minipage}
    } &
    \centering
    \fcolorbox{green}{white}{%
    \begin{minipage}{0.16\textwidth}
    \centering
    \textbf{Faibles}\\
    \vspace{0.2em}
    {\Large\color{green}#4}
    \end{minipage}
    } &
    \centering
    \fcolorbox{DollaramaGreen}{white}{%
    \begin{minipage}{0.16\textwidth}
    \centering
    \textbf{Opportunités}\\
    \vspace{0.2em}
    {\Large\color{DollaramaGreen}#5}
    \end{minipage}
    }
    \end{tabular}
    
    \vspace{0.5em}
    \end{minipage}
    }
    \end{center}
    \vspace{1em}
}

% ===============================================
% ANALYSE SWOT INTÉGRÉE
% ===============================================

\newcommand{\swotanalysis}[4]{
    \begin{table}[H]
    \centering
    \caption{Analyse SWOT - Contexte des Risques}
    \label{tab:swot-analysis}
    \begin{tabular}{|p{0.45\textwidth}|p{0.45\textwidth}|}
    \hline
    \dollaramatabheader
    \multicolumn{2}{|c|}{\dollaramatabheadertext{FACTEURS INTERNES}} \\
    \hline
    \cellcolor{green!30}\textbf{FORCES (Strengths)} & \cellcolor{red!30}\textbf{FAIBLESSES (Weaknesses)} \\
    \hline
    #1 & #2 \\
    \hline
    \dollaramatabheader
    \multicolumn{2}{|c|}{\dollaramatabheadertext{FACTEURS EXTERNES}} \\
    \hline
    \cellcolor{blue!30}\textbf{OPPORTUNITÉS (Opportunities)} & \cellcolor{orange!30}\textbf{MENACES (Threats)} \\
    \hline
    #3 & #4 \\
    \hline
    \end{tabular}
    \end{table}
}

% ===============================================
% MODÈLES DE RÉPONSE AUX RISQUES
% ===============================================

\newcommand{\riskresponseplan}[5]{
    \begin{tcolorbox}[
        colback=white,
        colframe=DollaramaGreen,
        boxrule=2pt,
        arc=3pt,
        title={\color{DollaramaGreen}\textbf{Plan de Réponse au Risque: #1}}
    ]
    
    \begin{tabular}{p{0.2\textwidth}p{0.75\textwidth}}
    \textbf{Stratégie:} & #2 \\[0.5em]
    \textbf{Actions:} & #3 \\[0.5em]
    \textbf{Responsable:} & #4 \\[0.5em]
    \textbf{Échéance:} & #5 \\
    \end{tabular}
    
    \end{tcolorbox}
}

% Fin du package
\endinput